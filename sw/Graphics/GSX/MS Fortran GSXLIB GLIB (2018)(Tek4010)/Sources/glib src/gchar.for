C ---------------------------------------------
C
C     Library module for graphics output
C
C     Martin Hepperle, 11/2018
C
C
C     f80 =gchar
C ---------------------------------------------
      SUBROUTINE GCHAR(X,Y,ICHR,SIZE,ANGLE)
C ---------------------------------------------
C     Output a character in UC
C
C     X, Y ... position of baseline point, updated
C     ICHAR .. character code (32...126)
C     SIZE ... size in millimeters
C     ANGLE .. baseline angle (deg), 0=right, 90=up
C ---------------------------------------------
C
      IMPLICIT LOGICAL(A-Z)

      REAL*4    X,Y,SIZE,ANGLE
      INTEGER*2 ICHR
C     local
      REAL*4 XPT,YPT,FX,FY,SCALX,SCALY,W,ARAD,SINA,COSA
      INTEGER*2 IMOVE,IPT,I,K,I0,I1,NCHR,NPTS
      INTEGER*2 START(96)
      INTEGER*1 PTS(2600)
C     INTEGER*1 WIDTH(96) in GLIB.FI

      INCLUDE GLIB.FI

C     preloaded SIMPLEX font

C     first entry: space character
      DATA WIDTH / 16,10,16,21,20,24,26,10,14,14,16,26,10,26,10,22,
     1             20,20,20,20,20,20,20,20,20,20,10,10,24,26,24,18,
     2             27,18,21,21,21,19,18,21,22,8,16,21,17,24,22,22,21,
     3             22,21,20,16,22,18,24,20,18,20,14,14,14,16,16,10,
     4             19,19,18,19,18,12,19,19,8,10,17,8,30,19,19,19,
     5             19,13,17,12,19,16,22,17,16,17,14,8,14,24 /

C     1st entry: space character  starts at 0, length =  0-0-1  = -1
C     2bd entry: exclamation mark starts at 0, length = 15-0-1  = 14
C     3rd entry: double quote     starts at 15 length = 24-15-1 = 9
      DATA START / 0,0,15,24,43,93,153,221,235,255,275,289,298,314,318,
     1             328,332,366,374,402,432,443,477,523,532,590,636,657,
     2             684,690,699,705,744,851,865,909,945,974,993,1007,
     3             1050,1064,1068,1088,1102,1111,1130,1144,1186,1211,
     4             1258,1288,1328,1337,1357,1366,1385,1394,1405,1419,
     5             1438,1442,1461,1479,1483,1497,1530,1563,1591,1624,
     6             1658,1673,1716,1735,1750,1771,1785,1789,1823,1842,
     7             1876,1909,1942,1957,1991,2006,2025,2034,2053,2062,
     8             2079,2093,2169,2173,2249,2294 /

      DATA NPTS / 2294 /
      DATA PTS / 5,4,5,18,127,5,23,4,24,5,25,6,24,5,23,4,4,
     *           4,11,127,12,4,12,11,11,0,4,32,127,17,0,10,32,
     *           127,4,13,18,13,127,3,19,17,19,8,0,8,29,127,12,
     *           0,12,29,127,17,7,15,5,12,4,8,4,5,5,3,7,
     *           3,9,4,11,5,12,7,13,13,15,15,16,16,17,17,19,
     *           17,22,15,24,12,25,8,25,5,24,3,22,21,4,3,25,
     *           127,8,4,10,6,10,8,9,10,7,11,5,11,3,9,3,
     *           7,4,5,6,4,8,4,10,5,13,6,16,6,19,5,21,
     *           4,127,17,18,15,19,14,21,14,23,16,25,18,25,20,24,
     *           21,22,21,20,19,18,17,18,23,13,23,12,22,11,21,11,
     *           20,12,19,14,17,19,15,22,13,24,11,25,7,25,5,24,
     *           4,23,3,21,3,19,4,17,5,16,12,12,13,11,14,9,
     *           14,7,13,5,11,4,9,5,8,7,8,9,9,12,11,15,
     *           16,22,18,24,20,25,22,25,23,24,23,23,5,6,4,5,
     *           5,4,6,5,6,7,5,9,4,10,11,0,9,2,7,5,
     *           5,9,4,14,4,18,5,23,7,27,9,30,11,32,3,0,
     *           5,2,7,5,9,9,10,14,10,18,9,23,7,27,5,30,
     *           3,32,8,4,8,16,127,3,7,13,13,127,13,7,3,13,
     *           13,7,13,25,127,4,16,22,16,6,24,5,25,4,24,5,
     *           23,6,24,6,26,5,28,4,29,4,16,22,16,5,23,4,
     *           24,5,25,6,24,5,23,20,0,2,32,9,4,6,5,4,
     *           8,3,13,3,16,4,21,6,24,9,25,11,25,14,24,16,
     *           21,17,16,17,13,16,8,14,5,11,4,9,4,6,8,8,
     *           7,11,4,11,25,4,9,4,8,5,6,6,5,8,4,12,
     *           4,14,5,15,6,16,8,16,10,15,12,13,15,3,25,17,
     *           25,5,4,16,4,10,12,13,12,15,13,16,14,17,17,17,
     *           19,16,22,14,24,11,25,8,25,5,24,4,23,3,21,13,
     *           4,3,18,18,18,127,13,4,13,25,15,4,5,4,4,13,
     *           5,12,8,11,11,11,14,12,16,14,17,17,17,19,16,22,
     *           14,24,11,25,8,25,5,24,4,23,3,21,16,7,15,5,
     *           12,4,10,4,7,5,5,8,4,13,4,18,5,22,7,24,
     *           10,25,11,25,14,24,16,22,17,19,17,18,16,15,14,13,
     *           11,12,10,12,7,13,5,15,4,18,17,4,7,25,127,3,
     *           4,17,4,8,4,5,5,4,7,4,9,5,11,7,12,11,
     *           13,14,14,16,16,17,18,17,21,16,23,15,24,12,25,8,
     *           25,5,24,4,23,3,21,3,18,4,16,6,14,9,13,13,
     *           12,15,11,16,9,16,7,15,5,12,4,8,4,16,11,15,
     *           14,13,16,10,17,9,17,6,16,4,14,3,11,3,10,4,
     *           7,6,5,9,4,10,4,13,5,15,7,16,11,16,16,15,
     *           21,13,24,10,25,8,25,5,24,4,22,5,11,4,12,5,
     *           13,6,12,5,11,127,5,23,4,24,5,25,6,24,5,23,
     *           5,11,4,12,5,13,6,12,5,11,127,6,24,5,25,4,
     *           24,5,23,6,24,6,26,5,28,4,29,20,7,4,16,20,
     *           25,4,13,22,13,127,4,19,22,19,4,7,20,16,4,25,
     *           3,9,3,8,4,6,5,5,7,4,11,4,13,5,14,6,
     *           15,8,15,10,14,12,13,13,9,15,9,18,127,9,23,8,
     *           24,9,25,10,24,9,23,18,12,17,10,15,9,12,9,10,
     *           10,9,11,8,14,8,17,9,19,11,20,14,20,16,19,17,
     *           17,127,12,9,10,11,9,14,9,17,10,19,11,20,127,18,
     *           9,17,17,17,19,19,20,21,20,23,18,24,15,24,13,23,
     *           10,22,8,20,6,18,5,15,4,12,4,9,5,7,6,5,
     *           8,4,10,3,13,3,16,4,19,5,21,7,23,9,24,12,
     *           25,15,25,18,24,20,23,21,22,127,19,9,18,17,18,19,
     *           19,20,9,4,1,25,127,9,4,17,25,127,4,18,14,18,
     *           4,4,4,25,127,4,4,13,4,16,5,17,6,18,8,18,
     *           10,17,12,16,13,13,14,127,4,14,13,14,16,15,17,16,
     *           18,18,18,21,17,23,16,24,13,25,4,25,18,9,17,7,
     *           15,5,13,4,9,4,7,5,5,7,4,9,3,12,3,17,
     *           4,20,5,22,7,24,9,25,13,25,15,24,17,22,18,20,
     *           4,4,4,25,127,4,4,11,4,14,5,16,7,17,9,18,
     *           12,18,17,17,20,16,22,14,24,11,25,4,25,4,4,4,
     *           25,127,4,4,17,4,127,4,14,12,14,127,4,25,17,25,
     *           4,4,4,25,127,4,4,17,4,127,4,14,12,14,18,9,
     *           17,7,15,5,13,4,9,4,7,5,5,7,4,9,3,12,
     *           3,17,4,20,5,22,7,24,9,25,13,25,15,24,17,22,
     *           18,20,18,17,127,13,17,18,17,4,4,4,25,127,18,4,
     *           18,25,127,4,14,18,14,4,4,4,25,12,4,12,20,11,
     *           23,10,24,8,25,6,25,4,24,3,23,2,20,2,18,4,
     *           4,4,25,127,18,4,4,18,127,9,13,18,25,4,4,4,
     *           25,127,4,25,16,25,4,4,4,25,127,4,4,12,25,127,
     *           20,4,12,25,127,20,4,20,25,4,4,4,25,127,4,4,
     *           18,25,127,18,4,18,25,9,4,7,5,5,7,4,9,3,
     *           12,3,17,4,20,5,22,7,24,9,25,13,25,15,24,17,
     *           22,18,20,19,17,19,12,18,9,17,7,15,5,13,4,9,
     *           4,4,4,4,25,127,4,4,13,4,16,5,17,6,18,8,
     *           18,11,17,13,16,14,13,15,4,15,9,4,7,5,5,7,
     *           4,9,3,12,3,17,4,20,5,22,7,24,9,25,13,25,
     *           15,24,17,22,18,20,19,17,19,12,18,9,17,7,15,5,
     *           13,4,9,4,127,12,21,18,27,4,4,4,25,127,4,4,
     *           13,4,16,5,17,6,18,8,18,10,17,12,16,13,13,14,
     *           4,14,127,11,14,18,25,17,7,15,5,12,4,8,4,5,
     *           5,3,7,3,9,4,11,5,12,7,13,13,15,15,16,16,
     *           17,17,19,17,22,15,24,12,25,8,25,5,24,3,22,8,
     *           4,8,25,127,1,4,15,4,4,4,4,19,5,22,7,24,
     *           10,25,12,25,15,24,17,22,18,19,18,4,1,4,9,25,
     *           127,17,4,9,25,2,4,7,25,127,12,4,7,25,127,12,
     *           4,17,25,127,22,4,17,25,3,4,17,25,127,17,4,3,
     *           25,1,4,9,14,9,25,127,17,4,9,14,17,4,3,25,
     *           127,3,4,17,4,127,3,25,17,25,4,0,4,32,127,5,
     *           0,5,32,127,4,0,11,0,127,4,32,11,32,0,4,14,
     *           28,9,0,9,32,127,10,0,10,32,127,3,0,10,0,127,
     *           3,32,10,32,6,10,8,7,10,10,127,3,13,8,8,13,
     *           13,127,8,8,8,25,0,27,16,27,6,4,5,5,4,7,
     *           4,9,5,10,6,9,5,8,15,11,15,25,127,15,14,13,
     *           12,11,11,8,11,6,12,4,14,3,17,3,19,4,22,6,
     *           24,8,25,11,25,13,24,15,22,4,4,4,25,127,4,14,
     *           6,12,8,11,11,11,13,12,15,14,16,17,16,19,15,22,
     *           13,24,11,25,8,25,6,24,4,22,15,14,13,12,11,11,
     *           8,11,6,12,4,14,3,17,3,19,4,22,6,24,8,25,
     *           11,25,13,24,15,22,15,4,15,25,127,15,14,13,12,11,
     *           11,8,11,6,12,4,14,3,17,3,19,4,22,6,24,8,
     *           25,11,25,13,24,15,22,3,17,15,17,15,15,14,13,13,
     *           12,11,11,8,11,6,12,4,14,3,17,3,19,4,22,6,
     *           24,8,25,11,25,13,24,15,22,10,4,8,4,6,5,5,
     *           8,5,25,127,2,11,9,11,15,11,15,27,14,30,13,31,
     *           11,32,8,32,6,31,127,15,14,13,12,11,11,8,11,6,
     *           12,4,14,3,17,3,19,4,22,6,24,8,25,11,25,13,
     *           24,15,22,4,4,4,25,127,4,15,7,12,9,11,12,11,
     *           14,12,15,15,15,25,3,4,4,5,5,4,4,3,3,4,
     *           127,4,11,4,25,5,4,6,5,7,4,6,3,5,4,127,
     *           6,11,6,28,5,31,3,32,1,32,4,4,4,25,127,14,
     *           11,4,21,127,8,17,15,25,4,4,4,25,4,11,4,25,
     *           127,4,15,7,12,9,11,12,11,14,12,15,15,15,25,127,
     *           15,15,18,12,20,11,23,11,25,12,26,15,26,25,4,11,
     *           4,25,127,4,15,7,12,9,11,12,11,14,12,15,15,15,
     *           25,8,11,6,12,4,14,3,17,3,19,4,22,6,24,8,
     *           25,11,25,13,24,15,22,16,19,16,17,15,14,13,12,11,
     *           11,8,11,4,11,4,32,127,4,14,6,12,8,11,11,11,
     *           13,12,15,14,16,17,16,19,15,22,13,24,11,25,8,25,
     *           6,24,4,22,15,11,15,32,127,15,14,13,12,11,11,8,
     *           11,6,12,4,14,3,17,3,19,4,22,6,24,8,25,11,
     *           25,13,24,15,22,4,11,4,25,127,4,17,5,14,7,12,
     *           9,11,12,11,14,14,13,12,10,11,7,11,4,12,3,14,
     *           4,16,6,17,11,18,13,19,14,21,14,22,13,24,10,25,
     *           7,25,4,24,3,22,5,4,5,21,6,24,8,25,10,25,
     *           127,2,11,9,11,4,11,4,21,5,24,7,25,10,25,12,
     *           24,15,21,127,15,11,15,25,2,11,8,25,127,14,11,8,
     *           25,3,11,7,25,127,11,11,7,25,127,11,11,15,25,127,
     *           19,11,15,25,3,11,14,25,127,14,11,3,25,2,11,8,
     *           25,127,14,11,8,25,6,29,4,31,2,32,1,32,14,11,
     *           3,25,127,3,11,14,11,127,3,25,14,25,9,0,7,1,
     *           6,2,5,4,5,6,6,8,7,9,8,11,8,13,6,15,
     *           127,7,1,6,3,6,5,7,7,8,8,9,10,9,12,8,
     *           14,4,16,8,18,9,20,9,22,8,24,7,25,6,27,6,
     *           29,7,31,127,6,17,8,19,8,21,7,23,6,24,5,26,
     *           5,28,6,30,7,31,9,32,4,0,4,32,5,0,7,1,
     *           8,2,9,4,9,6,8,8,7,9,6,11,6,13,8,15,
     *           127,7,1,8,3,8,5,7,7,6,8,5,10,5,12,6,
     *           14,10,16,6,18,5,20,5,22,6,24,7,25,8,27,8,
     *           29,7,31,127,8,17,6,19,6,21,7,23,8,24,9,26,
     *           9,28,8,30,7,31,5,32,3,19,3,17,4,14,6,13,
     *           8,13,10,14,14,17,16,18,18,18,20,17,21,15,127,3,
     *           17,4,15,6,14,8,14,10,15,14,18,16,19,18,19,20,
     *           18,21,15,21,13 /

      IF ( ICHR .GT. 0 ) GOTO 150

      IF ( ICHR .EQ. -1 ) GOTO 11
      IF ( ICHR .EQ. -2 ) GOTO 12
      IF ( ICHR .EQ. -10 ) GOTO 30

C     FONT #1: SIMPLEX
11    CONTINUE
      CALL OPEN(10,'FSIMPLEXFNT',0)
      GOTO 10

C     FONT #2: GREEK
12    CONTINUE
      CALL OPEN(10,'FGREEK  FNT',0)

10    CONTINUE
      READ(10) I,I,NPTS

      READ(10) (WIDTH(K),K=1,I)
      READ(10) (START(K),K=1,I)
      READ(10) (PTS(K),K=1,NPTS)
      ENDFILE 10
      RETURN

30    CONTINUE
      CALL OPEN(10,'FDUMPED FNT',0)
      I = 96
      WRITE(10) I,I,NPTS
      WRITE(10) (WIDTH(K),K=1,I)
      WRITE(10) (START(K),K=1,I)
      WRITE(10) (PTS(K),K=1,NPTS)
      ENDFILE 10
      RETURN

150   CONTINUE
      IF ( ICHR .LT.32 .OR. ICHR .GT. 126 ) RETURN

      NCHR = ICHR-31
      I0 = START(NCHR)+1

C     Note: MS-FTN 3.4 produces wrong code for START(ICHAR+1),
C     therefore we increment this outside of the array index
      NCHR = NCHR+1
      I1 = START(NCHR)+1

C     SCAL from mm to user units
      SCALX = SIZE*DEVSIX/(22.0*DEVXMM*SX)
      SCALY = SIZE*DEVSIY/(22.0*DEVYMM*SY)

      ARAD = ANGLE*0.01745329252
      SINA = SIN(ARAD)
      COSA = COS(ARAD)

      IMOVE = 1

200   CONTINUE
C     we use IPT to avoid feeding FLOAT with INTEGER*1
      IPT = PTS(I0)
      IF (IPT .EQ. 127) GOTO 210

      FX = FLOAT(IPT)
      I0 = I0+1
      IPT = PTS(I0)
      FY = (26.0 - FLOAT(IPT))
      I0 = I0+1

      XPT = X + (COSA*FX - SINA*FY)*SCALX
      YPT = Y + (SINA*FX + COSA*FY)*SCALY

      IF ( IMOVE .EQ. 1 ) GOTO 205
      CALL GDRAW(XPT,YPT)
      GOTO 220

205   CALL GMOVE(XPT,YPT)
      IMOVE = 0
      GOTO 220

210   IMOVE = 1
      I0 = I0+1

220   IF (I0 .LT. I1 ) GOTO 200

C     advance insertion point in UC
      W = WIDTH(ICHR-31)
      X = X + COSA*W*SCALX
      Y = Y + SINA*W*SCALY

      RETURN
      END
C ---------------------------------------------
      SUBROUTINE GSFONT(IOP)
C ---------------------------------------------
C     Select a font
C     IOP = 1  SIMPLEX  from 'FNTSIMPL.BIN'
C     IOP = 2  GREEK    from 'FNTGREEK.BIN'
C     Dump current fonrh
C     IOP = 10 dump font to 'FNTDUMP.BIN'
C ---------------------------------------------
C
      INTEGER IOP

      REAL*4    X,Y,SIZE,ANGLE
      INTEGER*2 ICHAR

      ICHAR = -IOP

      CALL GCHAR(X,Y,ICHAR,SIZE,ANGLE)

      RETURN
      END
C ---------------------------------------------
