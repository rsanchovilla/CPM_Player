C ---------------------------------------------
C
C     Library module for graphics output
C
C     Martin Hepperle, 11/2018
C
C
C     f80 =gchar
C ---------------------------------------------
      SUBROUTINE GCHAR(X,Y,ICHR,SIZE,ANGLE)
C ---------------------------------------------
C     Output a character in UC
C
C     X, Y ... position of baseline point, updated
C     ICHAR .. character code (32...126)
C     SIZE ... size in millimeters
C     ANGLE .. baseline angle (deg), 0=right, 90=up
C ---------------------------------------------
C
      IMPLICIT LOGICAL(A-Z)

      REAL*4    X,Y,SIZE,ANGLE
      INTEGER*2 ICHR
C     local
      REAL*4 XPT,YPT,FX,FY,SCALX,SCALY,W,ARAD,SINA,COSA
      INTEGER*2 IMOVE,IPT,I0,I1,NCHR
      INTEGER*2 START(96)
      INTEGER*1 PTS(3905)

      INCLUDE GLIB.FI

C     first entry: space character
      DATA WIDTH / 9,11,2,17,25,26,9,15,15,17,27,11,27,11,23,21,21,21,
     *21,21,21,21,21,21,21,11,11,25,27,25,19,0,21,23,22,23,22,21,24,25,
     *12,16,23,19,26,24,23,23,23,23,21,20,25,21,25,21,22,21,15,0,15,0,0,
     *0,21,22,20,22,20,14,20,23,12,12,22,12,34,23,21,22,21,18,18,16,23,
     *19,25,21,20,19,15,21,15,25,25 /

C     1st entry: space character  starts at 0, length =  0-0-1  = -1
C     2bd entry: exclamation mark starts at 0, length = 15-0-1  = 14
C     3rd entry: double quote     starts at 15 length = 24-15-1 = 9
      DATA START / 0,0,26,39,58,137,194,288,294,331,368,382,391,405,409,
     * 419,423,499,517,587,663,681,744,836,860,943,1016,1037,1062,1068,
     * 1077,1083,1143,1164,1190,1270,1331,1386,1423,1456,1530,1574,1593,
     * 1629,1673,1696,1733,1761,1845,1897,2019,2086,2118,2145,2197,2218,
     * 2248,2282,2315,2336,2349,2370,2383,2393,2401,2409,2482,2539,2592,
     * 2651,2709,2748,2861,2906,2933,2975,3016,3032,3106,3151,3202,3264,
     * 3324,3361,3422,3450,3489,3510,3540,3574,3612,3633,3709,3784,3860,
     * 3905 /

      DATA PTS / 0,4,-1,6,0,18,1,6,0,4,127,0,6,0,12,127,0,23,-1,24,0,25,
     *1,24,0,23,-3,4,-4,11,-2,4,127,5,4,4,11,6,4,6,4,-1,32,127,12,4,5,
     *32,127,-1,15,13,15,127,-2,21,12,21,5,0,5,29,127,9,0,9,29,127,13,7,
     *12,8,13,9,14,8,14,7,12,5,9,4,5,4,2,5,0,7,0,9,1,11,2,12,4,13,10,15,
     *12,16,14,18,127,0,9,2,11,4,12,10,14,12,15,13,16,14,18,14,22,12,24,
     *9,25,5,25,2,24,0,22,0,21,1,20,2,21,1,22,3,4,5,6,5,8,4,10,2,11,0,
     *11,-2,9,-2,7,-1,5,1,4,3,4,5,5,8,6,11,6,14,5,16,4,-2,25,127,12,18,
     *10,19,9,21,9,23,11,25,13,25,15,24,16,22,16,20,14,18,12,18,18,12,
     *17,13,18,14,19,13,19,12,18,11,17,11,16,12,15,14,13,19,11,22,9,24,
     *7,25,4,25,1,24,0,22,0,19,1,17,7,13,9,11,10,9,10,7,9,5,7,4,5,5,4,7,
     *4,9,5,12,7,15,12,22,14,24,17,25,18,25,19,24,19,23,127,4,25,2,24,
     *1,22,1,19,2,17,4,15,127,4,9,5,11,13,22,15,24,17,25,9,4,8,11,10,4,
     *5,0,3,2,1,5,-1,9,-2,14,-2,18,-1,23,1,27,3,30,5,32,127,3,2,1,6,0,9,
     *-1,14,-1,18,0,23,1,26,3,30,-1,0,1,2,3,5,5,9,6,14,6,18,5,23,3,27,
     *1,30,-1,32,127,1,2,3,6,4,9,5,14,5,18,4,23,3,26,1,30,4,4,4,16,127,
     *-1,7,9,13,127,9,7,-1,13,5,7,5,25,127,-4,16,14,16,9,25,8,24,9,23,
     *10,24,10,26,9,28,8,29,-8,16,10,16,9,23,8,24,9,25,10,24,9,23,10,0,
     *-8,32,8,4,5,5,3,8,2,13,2,16,3,21,5,24,8,25,10,25,13,24,15,21,16,
     *16,16,13,15,8,13,5,10,4,8,4,127,8,4,6,5,5,6,4,8,3,13,3,16,4,21,5,
     *23,6,24,8,25,127,10,25,12,24,13,23,14,21,15,16,15,13,14,8,13,6,
     *12,5,10,4,3,8,5,7,8,4,8,25,127,7,5,7,25,127,3,25,12,25,-2,8,-1,9,
     *-2,10,-3,9,-3,8,-2,6,-1,5,2,4,6,4,9,5,10,6,11,8,11,10,10,12,7,14,
     *2,16,0,17,-2,19,-3,22,-3,25,127,6,4,8,5,9,6,10,8,10,10,9,12,6,14,
     *2,16,127,0,22,5,25,9,25,10,24,11,22,11,20,1,8,2,9,1,10,0,9,0,8,1,
     *6,2,5,5,4,9,4,12,5,13,7,13,10,12,12,9,13,6,13,127,9,4,11,5,12,7,
     *12,10,11,12,9,13,127,9,13,11,14,13,16,14,18,14,21,13,23,12,24,9,
     *25,5,25,2,24,1,23,0,21,0,20,1,19,2,20,1,21,9,6,9,25,127,15,19,-1,
     *19,10,4,10,25,127,6,25,13,25,3,5,8,5,13,4,3,4,1,14,3,12,6,11,9,11,
     *12,12,14,14,15,17,15,19,14,22,12,24,9,25,6,25,3,24,2,23,1,21,1,20,
     *2,19,3,20,2,21,127,9,11,11,12,13,14,14,17,14,19,13,22,11,24,9,25,
     *12,7,11,8,12,9,13,8,13,7,12,5,10,4,7,4,4,5,2,7,1,9,0,13,0,19,1,22,
     *3,24,6,25,8,25,11,24,13,22,14,19,14,18,13,15,11,13,8,12,7,12,4,13,
     *2,15,1,18,127,7,4,5,5,3,7,2,9,1,13,1,19,2,22,4,24,6,25,127,8,25,
     *10,24,12,22,13,19,13,18,12,15,10,13,8,12,0,4,0,10,127,1,6,3,5,5,5,
     *10,7,127,13,10,8,15,7,17,6,20,6,25,5,4,2,5,1,7,1,10,2,12,5,13,9,
     *13,12,12,13,10,13,7,12,5,9,4,5,4,3,5,2,7,2,10,3,12,5,13,2,14,1,15,
     *0,17,0,21,1,23,2,24,5,25,9,25,12,24,13,23,14,21,14,17,13,15,12,14,
     *9,13,127,5,13,3,14,2,15,1,17,1,21,2,23,3,24,5,25,13,11,12,14,10,
     *16,7,17,6,17,3,16,1,14,0,11,0,10,1,7,3,5,6,4,8,4,11,5,13,7,14,10,
     *14,16,13,20,12,22,10,24,7,25,4,25,2,24,1,22,1,21,2,20,3,21,2,22,
     *127,6,17,4,16,2,14,1,11,1,10,2,7,4,5,6,4,7,11,6,12,7,13,8,12,7,11
     *,127,7,23,6,24,7,25,8,24,7,23,1,11,0,12,1,13,2,12,1,11,127,1,25,
     *0,24,1,23,2,24,2,26,1,28,0,29,9,7,-7,16,9,25,-1,13,17,13,127,-1,
     *19,17,19,1,7,17,16,1,25,3,8,4,9,3,10,2,9,2,8,3,6,4,5,6,4,9,4,12,5,
     *13,6,14,8,14,10,13,12,12,13,8,15,8,18,127,9,4,11,5,12,6,13,8,13,
     *10,12,12,10,14,127,8,23,7,24,8,25,9,24,8,23,-1,-3,-2,-2,-1,-1,0,
     *-2,-1,-3,127,13,-3,12,-2,13,-1,14,-2,13,-3,1,25,8,4,15,25,127,8,7,
     *14,25,127,-1,25,5,25,127,3,19,12,19,127,11,25,17,25,3,4,3,25,127,
     *4,25,4,4,127,0,4,12,4,15,5,16,6,17,8,17,10,16,12,15,13,12,14,127,
     *4,14,12,14,15,15,16,16,17,18,17,21,16,23,15,24,12,25,0,25,127,12,
     *4,14,5,15,6,16,8,16,10,15,12,14,13,12,14,14,15,15,16,16,18,16,21,
     *15,23,14,24,12,25,15,7,16,10,16,4,15,7,13,5,10,4,8,4,5,5,3,7,2,9,
     *1,12,1,17,2,20,3,22,5,24,8,25,10,25,13,24,15,22,16,20,127,8,4,6,5,
     *4,7,3,9,2,12,2,17,3,20,4,22,6,24,8,25,2,4,2,25,127,3,25,3,4,127,
     *-1,4,9,4,12,5,14,7,15,9,16,12,16,17,15,20,14,22,12,24,9,25,-1,25,
     *127,9,4,11,5,13,7,14,9,15,12,15,17,14,20,13,22,11,24,9,25,3,4,3,
     *25,127,4,25,4,4,127,0,4,16,4,16,10,15,4,127,10,10,10,18,127,10,14,
     *4,14,127,0,25,16,25,16,19,15,25,3,4,3,25,127,4,25,4,4,127,0,4,16,
     *4,16,10,15,4,127,10,10,10,18,127,4,14,10,14,127,0,25,7,25,15,7,
     *16,10,16,4,15,7,13,5,10,4,8,4,5,5,3,7,2,9,1,12,1,17,2,20,3,22,5,
     *24,8,25,10,25,13,24,15,22,127,8,4,6,5,4,7,3,9,2,12,2,17,3,20,4,22,
     *6,24,8,25,127,15,25,15,17,127,12,17,19,17,127,16,17,16,25,1,4,1,
     *25,127,-2,25,5,25,127,2,25,2,4,127,-2,4,5,4,127,2,14,14,14,127,
     *14,25,14,4,127,11,4,18,4,127,15,4,15,25,127,11,25,18,25,8,25,8,4,
     *127,5,4,12,4,127,9,4,9,25,127,5,25,12,25,3,25,4,24,5,21,5,4,127,
     *2,4,9,4,127,6,4,6,21,5,24,3,25,1,25,-1,24,-2,22,-2,20,-1,19,0,20,
     *-1,21,-2,25,-2,4,127,-5,4,2,4,127,-1,4,-1,25,127,-5,25,2,25,127,
     *-1,17,12,4,127,8,4,14,4,127,3,13,11,25,127,8,25,14,25,127,12,25,
     *4,13,1,25,1,4,127,-2,4,5,4,127,2,4,2,25,127,-2,25,13,25,13,19,12,
     *25,-3,4,1,4,7,22,127,3,25,-3,25,127,0,25,0,4,7,25,14,4,14,25,127,
     *11,25,18,25,127,15,25,15,4,127,14,4,18,4,-2,25,4,25,127,1,25,1,4,
     *127,-2,4,2,4,14,23,127,2,6,14,25,14,4,127,11,4,17,4,8,4,5,5,3,7,
     *2,9,1,13,1,16,2,20,3,22,5,24,8,25,10,25,13,24,15,22,16,20,17,16,
     *17,13,16,9,15,7,13,5,10,4,8,4,127,8,4,6,5,4,7,3,9,2,13,2,16,3,20,
     *4,22,6,24,8,25,127,10,25,12,24,14,22,15,20,16,16,16,13,15,9,14,7,
     *12,5,10,4,2,4,2,25,127,-1,25,6,25,127,3,25,3,4,127,-1,4,11,4,14,5,
     *15,6,16,8,16,11,15,13,14,14,11,15,3,15,127,11,4,13,5,14,6,15,8,
     *15,11,14,13,13,14,11,15,8,4,5,5,3,7,2,9,1,13,1,16,2,20,3,22,5,24,
     *8,25,10,25,13,24,15,22,16,20,17,16,17,13,16,9,15,7,13,5,10,4,8,4,
     *127,8,4,6,5,4,7,3,9,2,13,2,16,3,20,4,22,6,24,8,25,127,10,25,12,24,
     *14,22,15,20,16,16,16,13,15,9,14,7,12,5,10,4,127,5,23,5,22,6,20,8,
     *19,9,19,11,20,12,22,13,29,14,30,16,30,17,28,17,27,127,12,22,13,26,
     *14,28,15,29,16,29,17,28,2,4,2,25,127,-1,25,6,25,127,3,25,3,4,127,
     *-1,4,11,4,14,5,15,6,16,8,16,10,15,12,14,13,11,14,3,14,127,11,4,
     *13,5,14,6,15,8,15,10,14,12,13,13,11,14,127,10,15,11,17,13,24,14,
     *25,16,25,17,23,17,22,15,7,16,4,16,10,15,7,13,5,10,4,7,4,4,5,2,7,
     *2,9,3,11,4,12,6,13,12,15,14,16,16,18,7,4,7,25,127,4,25,11,25,127,
     *8,25,8,4,127,1,4,0,10,0,4,15,4,15,10,14,4,0,4,0,19,1,22,3,24,6,25,
     *8,25,11,24,13,22,14,19,14,4,127,17,4,11,4,127,4,4,-3,4,127,1,4,1,
     *19,2,22,4,24,6,25,127,13,4,13,19,12,22,10,24,8,25,10,4,16,4,127,
     *14,4,7,25,0,4,127,-2,4,4,4,127,1,4,7,22,14,4,20,4,127,17,4,13,25,
     *9,4,5,25,1,4,127,-2,4,5,4,127,2,4,5,20,127,10,4,13,20,2,4,15,25,
     *127,12,25,18,25,127,16,25,3,4,127,0,4,6,4,127,12,4,18,4,127,16,4,
     *2,25,127,0,25,6,25,2,4,9,15,9,25,127,6,25,13,25,127,10,25,10,15,
     *3,4,127,0,4,6,4,127,13,4,19,4,127,17,4,10,15,3,4,2,10,2,4,16,4,3,
     *25,127,15,4,2,25,16,25,16,19,15,25,11,0,4,0,4,32,11,32,127,5,0,5,
     *32,-2,4,-3,5,-2,6,-1,5,-2,4,127,9,4,8,5,9,6,10,5,9,4,8,0,8,32,
     *127,2,0,9,0,9,32,2,32,-4,8,4,3,12,8,4,4,-4,8,10,2,11,3,5,8,10,2,
     *1,2,0,3,6,8,1,2,-1,13,-1,14,-2,14,-2,13,-1,12,1,11,5,11,7,12,8,13,
     *9,15,9,22,10,24,11,25,127,8,13,8,22,9,24,11,25,12,25,127,8,15,7,
     *16,1,17,-2,18,-3,20,-3,22,-2,24,1,25,4,25,6,24,8,22,127,1,17,-1,
     *18,-2,20,-2,22,-1,24,1,25,0,25,0,4,127,-3,4,1,4,1,25,127,1,14,3,
     *12,5,11,7,11,10,12,12,14,13,17,13,19,12,22,10,24,7,25,5,25,3,24,
     *1,22,127,7,11,9,12,11,14,12,17,12,19,11,22,9,24,7,25,14,14,13,15,
     *14,16,15,15,15,14,13,12,11,11,8,11,5,12,3,14,2,17,2,19,3,22,5,24,
     *8,25,10,25,13,24,15,22,127,8,11,6,12,4,14,3,17,3,19,4,22,6,24,8,
     *25,16,25,12,25,12,4,127,9,4,13,4,13,25,127,12,14,10,12,8,11,6,11,
     *3,12,1,14,0,17,0,19,1,22,3,24,6,25,8,25,10,24,12,22,127,6,11,4,12,
     *2,14,1,17,1,19,2,22,4,24,6,25,1,17,13,17,13,15,12,13,11,12,9,11,
     *6,11,3,12,1,14,0,17,0,19,1,22,3,24,6,25,8,25,11,24,13,22,127,12,
     *17,12,14,11,12,127,6,11,4,12,2,14,1,17,1,19,2,22,4,24,6,25,10,5,
     *9,6,10,7,11,6,11,5,10,4,8,4,6,5,5,7,5,25,127,2,25,9,25,127,6,25,
     *6,7,7,5,8,4,127,2,11,10,11,4,11,2,12,1,13,0,15,0,17,1,19,2,20,4,
     *21,6,21,8,20,9,19,10,17,10,15,9,13,8,12,6,11,4,11,127,2,12,1,14,
     *1,18,2,20,127,8,20,9,18,9,14,8,12,127,9,13,10,12,12,11,12,12,10,
     *12,127,1,19,0,20,-1,22,-1,23,0,25,3,26,8,26,11,27,12,28,127,-1,23,
     *0,24,3,25,8,25,11,26,12,28,12,29,11,31,8,32,2,32,-1,31,-2,29,-2,
     *28,-1,26,2,25,-2,25,5,25,127,1,25,1,4,127,-2,4,2,4,2,25,127,2,14,
     *4,12,7,11,9,11,12,12,13,14,13,25,127,9,11,11,12,12,14,12,25,127,
     *9,25,16,25,9,4,8,5,9,6,10,5,9,4,127,9,11,9,25,127,6,11,10,11,10,
     *25,127,6,25,13,25,4,4,3,5,4,6,5,5,4,4,127,1,11,5,11,5,29,4,31,2,
     *32,0,32,-1,31,-1,30,0,29,1,30,0,31,127,2,32,3,31,4,29,4,11,-5,25,
     *2,25,127,-2,25,-2,4,127,-5,4,-1,4,-1,25,127,-1,21,9,11,127,6,11,
     *12,11,127,3,17,9,25,127,6,25,12,25,127,10,25,4,17,9,25,9,4,127,6,
     *4,10,4,10,25,127,6,25,13,25,-8,25,-8,11,127,-11,11,-7,11,-7,25,
     *127,-11,25,-4,25,127,-7,14,-5,12,-2,11,0,11,3,12,4,14,4,25,127,7,
     *25,0,25,127,3,25,3,14,2,12,0,11,127,4,14,6,12,9,11,11,11,14,12,
     *15,14,15,25,127,18,25,11,25,127,14,25,14,14,13,12,11,11,1,25,-6,
     *25,127,-3,25,-3,11,127,-6,11,-2,11,-2,25,127,-2,14,0,12,3,11,5,11,
     *8,12,9,14,9,25,127,12,25,5,25,127,8,25,8,14,7,12,5,11,8,11,5,12,
     *3,14,2,17,2,19,3,22,5,24,8,25,10,25,13,24,15,22,16,19,16,17,15,14,
     *13,12,10,11,8,11,127,8,11,6,12,4,14,3,17,3,19,4,22,6,24,8,25,5,32,
     *-2,32,127,1,32,1,11,127,-2,11,2,11,2,32,127,2,14,4,12,6,11,8,11,
     *11,12,13,14,14,17,14,19,13,22,11,24,8,25,6,25,4,24,2,22,127,8,11,
     *10,12,12,14,13,17,13,19,12,22,10,24,8,25,15,11,15,32,127,18,32,
     *11,32,127,14,32,14,11,127,14,14,12,12,10,11,8,11,5,12,3,14,2,17,
     *2,19,3,22,5,24,8,25,10,25,12,24,14,22,127,8,11,6,12,4,14,3,17,3,
     *19,4,22,6,24,8,25,0,11,4,11,4,25,127,0,25,7,25,127,3,25,3,11,127,
     *4,17,5,14,7,12,9,11,12,11,13,12,13,13,12,14,11,13,12,12,12,13,13,
     *11,13,15,12,13,11,12,9,11,5,11,3,12,2,13,2,15,3,16,5,17,10,19,12,
     *20,13,21,127,2,14,3,15,5,16,10,18,12,19,13,20,13,23,12,24,10,25,
     *6,25,4,24,3,23,2,21,2,25,3,23,3,4,3,21,4,24,6,25,8,25,10,24,11,22
     *,127,4,4,4,21,5,24,6,25,127,0,11,8,11,-1,11,-1,22,0,24,3,25,5,25,
     *8,24,10,22,127,-4,11,0,11,0,22,1,24,3,25,127,14,25,10,25,10,11,
     *127,7,11,11,11,11,25,11,11,17,11,127,15,11,9,25,3,11,127,1,11,7,
     *11,127,4,11,9,23,13,11,19,11,127,16,11,12,25,8,11,4,25,0,11,127,
     *-3,11,4,11,127,1,11,4,22,127,9,11,12,22,2,11,13,25,127,10,25,16,
     *25,127,14,25,3,11,127,0,11,6,11,127,10,11,16,11,127,14,11,2,25,
     *127,0,25,6,25,8,25,2,11,127,0,11,6,11,127,3,11,8,23,127,10,11,16,
     *11,127,14,11,8,25,6,29,4,31,2,32,1,32,0,31,1,30,2,31,3,11,2,15,2,
     *11,14,11,3,25,127,13,11,2,25,14,25,14,21,13,25,8,0,6,1,5,2,4,4,4,
     *6,5,8,6,9,7,11,7,13,5,15,127,6,1,5,3,5,5,6,7,7,8,8,10,8,12,7,14,
     *3,16,7,18,8,20,8,22,7,24,6,25,5,27,5,29,6,31,127,5,17,7,19,7,21,
     *6,23,5,24,4,26,4,28,5,30,6,31,8,32,-3,32,-3,14,-2,9,0,5,2,4,127,
     *-4,32,-4,14,-3,9,-1,5,1,4,5,4,8,5,9,7,9,10,8,12,5,13,127,5,4,7,5,
     *8,7,8,10,7,12,5,13,7,14,9,16,10,18,10,21,9,23,8,24,5,25,3,25,127,
     *8,15,9,18,9,21,8,23,7,24,5,25,5,0,7,1,8,2,9,4,9,6,8,8,7,9,6,11,6,
     *13,8,15,127,7,1,8,3,8,5,7,7,6,8,5,10,5,12,6,14,10,16,6,18,5,20,5,
     *22,6,24,7,25,8,27,8,29,7,31,127,8,17,6,19,6,21,7,23,8,24,9,26,9,
     *28,8,30,7,31,5,32,-7,19,-7,17,-6,14,-4,13,-2,13,0,14,4,17,6,18,8,
     *18,10,17,11,15,127,-7,17,-6,15,-4,14,-2,14,0,15,4,18,6,19,8,19,
     *10,18,11,15,11,13 /

      IF ( ICHR .LT.32 .OR. ICHR .GT. 126 ) RETURN

      NCHR = ICHR-31
      I0 = START(NCHR)+1

C     Note: MS-FTN 3.4 produces wrong code for START(ICHAR+1),
C     therefore we increment this outside of the array index
      NCHR = NCHR+1
      I1 = START(NCHR)+1

C     SCAL from mm to user units
      SCALX = SIZE*DEVSIX/(22.0*DEVXMM*SX)
      SCALY = SIZE*DEVSIY/(22.0*DEVYMM*SY)

      ARAD = ANGLE*0.01745329252
      SINA = SIN(ARAD)
      COSA = COS(ARAD)

      IMOVE = 1

200   CONTINUE
C     we use IPT to avoid feeding FLOAT with INTEGER*1
      IPT = PTS(I0)
      IF (IPT .EQ. 127) GOTO 210

      FX = FLOAT(IPT)
      I0 = I0+1
      IPT = PTS(I0)
      FY = (26.0 - FLOAT(IPT))
      I0 = I0+1

      XPT = X + (COSA*FX - SINA*FY)*SCALX
      YPT = Y + (SINA*FX + COSA*FY)*SCALY

      IF ( IMOVE .EQ. 1 ) GOTO 205
      CALL GDRAW(XPT,YPT)
      GOTO 220

205   CALL GMOVE(XPT,YPT)
      IMOVE = 0
      GOTO 220

210   IMOVE = 1
      I0 = I0+1

220   IF (I0 .LT. I1 ) GOTO 200

C     advance insertion point in UC
      W = WIDTH(ICHR-31)
      X = X + COSA*W*SCALX
      Y = Y + SINA*W*SCALY

      RETURN
      END
C ---------------------------------------------
