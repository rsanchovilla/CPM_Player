\ locals                                                                                                                        based on locals code by B. Muench                                                                                               LOCAL   x LOCAL name    define a local with value x             TO      x TO name       assign a value to a local               ADDR    ADDR name       get address of local                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ locals                                                        forth definitions  decimal                                      application                                                                                                                     2  #screens 1-  thru                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ locals                                                        #20 user LP  \ locals pointer (don't change)                                                                                    \ add locals to CATCH                                           -? : CATCH  ( xt -- except# | 0 )                                 lp @ >r catch r> over if lp ! else drop then ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ locals                                                        label lods  \ DE <- (IP)+                                         b ldax  a e mov  b inx  0 d mvi  ret  end-code                                                                                label ladr  \ HL <- address of local                              LP [up]  m e mov  h inx  m d mov  xchg  lods call  dsub jmp   end-code                                                                                                                        code L@ ( -- x )  \ fetch local                                   ladr call  m a mov  h inx  m h mov  a l mov  1push  end-code                                                                  code L! ( x -- )  \ store local                                   ladr call  d pop  e m mov  h inx  d m mov  next  end-code                                                                     code L& ( -- addr )  \ address of local                           ladr call  1push  end-code                                    \ locals                                                        \ build locals frame & init locals                              code L{  ( -- ) ( R: -- lp i*x )                                  LP [up]  h push  m e mov  h inx  m d mov                        RPP lhld  h dcx  d m mov  h dcx  e m mov                        d pop  l a mov  d stax  d inx  h a mov  d stax                  lods call  dsub call  RPP shld  next                          end-code                                                                                                                        \ remove locals frame                                           code }L  ( -- ) ( R: lp i*x -- )                                  LP [up]  h push  m e mov  h inx  m d mov                        xchg  m e mov  h inx  m d mov  h inx  RPP shld                  h pop  e m mov  h inx  d m mov  next  end-code                                                                                                                                                \ locals                                                        system                                                          : ERR? ( x -- )  abort" locals error" ;                         : LGET ( "name" -- c-addr u )  token dup 0= err? ;                                                                              #128 constant #NB     \ name buffer size                        create NB  #nb allot  \ name buffer                             variable LO           \ locals offset                           variable NP           \ name pointer                            variable PA           \ patch addr                                                                                              : L[ ( -- )  lo off  nb #nb erase  nb np ! ;  l[                : ]L ( -- )  lo @ if  postpone }l  lo @ pa @ c!  then ;                                                                         \ local offset                                                  : LOS ( ? index -- u )  nip cells ;                             \ locals                                                        \ search local names                                            : L= ( c-addr -- index | 0 )                                      0  state @ if  \ compiling only                                   nb >r                                                           begin  1+  r@ c@ 0<> and  dup                                   while  over count  r> count  2dup + >r                                 caps compare 0=                                          until  then  r> drop                                          then  nip ;                                                                                                                   \ new FIND                                                      : LFIND ( c-addr -- c-addr 0 | xt flag )                          dup l= ?dup if  postpone l@  los c,  ['] noop 1  exit  then     [ addr find @ compile, ] ;                                                                                                    \ +LOC LOCAL                                                    \ add local                                                     : +LOC ( "name" -- )                                              lget  np @  2dup +  nb #nb 2-  + u> err?                        over 1+ np +!  place                                            lo @ 0= if  postpone l{  here  0 c,  pa !  then ;                                                                                                                                             : LOCAL ( "name" -- )                                             +loc  1 cells lo +!  postpone l!  lo @ c, ; immediate                                                                                                                                                                                                                                                                                                                                                                                                         \ TO ADDR                                                       -? : TO ( x "name" -- )  \ ANS                                    >in @  bl word l= ?dup                                          if  postpone l!  los c,  exit  then                             >in !  postpone to ;  immediate                                                                                               \ Address of a local                                            -? : ADDR ( "name" -- addr )                                      >in @  bl word l= ?dup                                          if  postpone l&  los c,  exit  then                             >in !  postpone addr ;  immediate                                                                                                                                                                                                                                                                                                                                                             \ locals                                                        -? : EXIT   ]l  postpone exit ;       immediate                 -? : ;      ]l  postpone ; ;          immediate                 -? : DOES>  ]l  postpone does>  l[ ;  immediate                 -? : ;CODE  ]l  postpone ;code ;      immediate                 -? : :  :  l[ ;                                                 -? : :NONAME  :noname  l[ ;                                                                                                     \ add to remember chain                                         :noname  [ addr find @ ] literal is find ;  remember            ' lfind is find                                                                                                                 application                                                                                                                                                                                                                                                     \ locals                                                        behead lods +loc                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                