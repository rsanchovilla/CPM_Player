1 FILL 280,1\REM Disable Ctrl-C check 
2 REM *** PORT FOR NS5BAS.COM - NorthStar Basic Revision 5.2 for CP/M *** 
3 REM *** C000-E000 for PCODE, B000-E000 for 8080 code
4 DIM V$(1)
5 !
10 !"         'TINY' PASCAL COMPILER FOR P-MACHINE"
20 !
21 INPUT"            CLEAR P-CODE AREA? ",V$
22 IF V$<>"Y"THEN 30
23 !
24 !"               CLEARING P-CODE AREA (C000-E000)"
25 !"                     (TAKES 30 SECONDS)"
28 FOR X=49512 TO 57344\FILL X,255\NEXT
30 ! 
35 FILL 4923,0\FILL 4924,0\REM Makes OUT to call 0000 -> exit to CPM
40 N0=32
50 T0=50
60 N1=32767
70 N2=8
80 DIMW0$(5*N0)
90 DIM T$(T0*N2)
100 DIM T0$(T0)
110 DIM L$(132)
120 DIM A$(N2),B$(5)
130 DIM S(100),S$(100)
140 DIM T1(T0)
150 DIM T2(T0)
160 DIM T3(T0)
170 W0$(1,40)="AND  ARRAYBEGINCALL CASE CONSTDIV  DO   "
180 W0$(41,80)="DOWNTELSE END  FOR  FUNC IF   INTEGMEM  "
190 W0$(81,120)="MOD  NOT  OF   OR   PROC READ REPEASHL  "
200 W0$(121,160)="SHR  THEN TO   TYPE UNTILVAR  WHILEWRITE"
210 DIM M$(27),C$(80)
220 M$="LITOPRLODSTOCALINTJMPJPCCSP"
230 P8=1
240 P7=49152\P9=P7
260 Q9=P7+4096*2
270 F5=-1
280 INPUT"            WANT CODE PRINTED? ",Y$
285 !\!\!
287!"     ENTER PASCAL SOURCE CODE. IF SOURCE IS ON DISK FILE"
288!"             PREFIX DISKFILE NAME WITH '$'"\!\!
290 IF Y$="Y" THEN Y9=0 ELSE Y9=1
300 X$=" "\GOSUB 1240
310 GOSUB 5340
320 Z=FNE1(".",9)
330 FILL P9,255\FILL P9+1,255
332 L9=INT((P9-P7+1)/256)+1
334 !\!"   PSIZE OF P-CODES:",L9," BLOCKS"\!
340 INPUT " EXIT (E), INTERPRET (I) OR TRANSLATE (T)? ",Y$
350 IF Y$="E" THEN 380
360 IF Y$="I" THEN 365
361 IF Y$="T" THEN 375
362 GOTO 340
365 !" GENERATE PROG.P FILE"
366 DESTROY "PROG.P"\CREATE "PROG.P"
367 OPEN#1,"PROG.P"
368 FOR I=P7 TO P9\C=EXAM(I)\WRITE#1,&C,NOENDMARK\NEXT
369 CLOSE#1
370 !" LOADING INTERPRETER ..."
371 REM EXEC: PASRUN1A PROG.P
372 FILL 129,1\CHAIN "PASLOAD"
373 GOTO 380
375 !" LOADING TRANSLATOR"
377 CHAIN "PASTRANS"
380 OUT\END
390REM ***************
400REM ERROR ROUTINES
410REM ***************
420 REM FNE1
430 DEF FNE1(K$,E)
440 IF S0$<>K$THEN Z=FNE(E)
450 RETURN 0
460 FNEND
470 REM*****
480 REM FNE2
481 REM*****
490 DEF FNE2(K$,E)
500 GOSUB 1240
510 IF S0$<>K$ THEN Z=FNE(E)
520 RETURN 0
530 FNEND
540 REM ***
550 REM PRINT ERRMSG
551 REM ***
560 DEF FNE(E9)
570 !TAB(C0+4),"^",E9
580 GOSUB 610
585 !" EDIT AND RE-COMPILE"\!
587 GOTO 380
590 END
600 RETURN 0\FNEND
610 REM ERROR MSGS
620 ON INT((E9-1)/5)+1 GOTO 630,640,650,660,670,680,690,700
630 ON E9 GOTO 710,720,730,740,750
640 ON E9-5 GOTO 990,990,990,760,770
650 ON E9-10 GOTO 780,790,800,990,990
660 ON E9-15 GOTO 810,820,830,840,850
670 ON E9-20 GOTO 860,870,880,990,890
680 ON E9-25 GOTO 900,910,920,990,930
690 ON E9-30 GOTO 940,990,950,960,970
700 ON E9-35 GOTO 980
710!" MEMORY FULL"\RETURN
720!" CONST EXPECTED"\RETURN
730!" '=' EXPECTED"\RETURN
740!" IDENTIFIER EXPECTED"\RETURN
750!" ';' OR ':' MISSING"\RETURN
760!" '.' EXPECTED"\RETURN
770!" ';' MISSING"\RETURN
780!" UNDECLARED IDENTIFIER"\RETURN
790!" ILLEGAL IDENTIFIER"\RETURN
800!" ':=' EXPECTED"\RETURN
810!" 'THEN' EXPECTED"\RETURN
820!" ';' OR 'END' EXPECTED"\RETURN
830!" 'DO' EXPECTED"\RETURN
840!" INCORRECT SYMBOL"\RETURN
850!" RELATIONAL OPERATOR EXPECTED"\RETURN
860!" USE OF PROC IDENT IN EXPR"\RETURN
870!" ')' EXPECTED"\RETURN
880!" ILLEGAL FACTOR"\RETURN
890!" 'BEGIN' EXPECTED"\RETURN
900!" 'OF' EXPECTED"\RETURN
910!" ILLEGAL HEX CONST"\RETURN
920!" 'TO' OR 'DOWNTO' EXPECTED"\RETURN
930!" NUMBER OUT OF RANGE"\RETURN
940!" '(' EXPECTED"\RETURN
950!" '[' EXPECTED"\RETURN
960!" ']' EXPECTED"\RETURN
970!" PARAMETERS MISMATCHED"\RETURN
980!" DATA TYPE NOT RECOGNISED"\RETURN
990!" BUG!"\RETURN
1000 REM ******
1010 REM SCANNER
1020 REM ******
1030 REM GETCHAR
1040 IF C0<L0 THEN 1060
1050 GOSUB 1090\GOTO1040
1060C0=C0+1\X$=L$(C0,C0)
1070 RETURN
1080 REM ***
1090 REM INPUT A LINE
1091 REM ***
1100 !%4I,C1," ",
1110 IF F5<0 THEN INPUT L$ ELSE 1160
1120 IF L$=""THEN 1100
1130 IF L$(1,1)="$" THEN 1210
1140 L$=L$+" "\C0=0
1150 L0=LEN(L$)\RETURN
1160 IF TYP(F5)<>0 THEN 1190
1170 CLOSE#F5\F5=F5-1
1180 GOTO 1110
1190 L$=""
1191 READ#F5,&C9
1195 IF C9=13 OR C9=9 THEN 1191
1196 IF C9=10 THEN 1199
1197 IF C9<32 THEN 1191
1198 L$=L$+CHR$(C9)\GOTO 1191
1199 !L$\IF L$="" THEN 1191
1200 GOTO 1130
1210 F5=F5+1\OPEN#F5,L$(2,LEN(L$))
1220 GOTO 1090
1230 REM ********
1240 REM GET A TOKEN
1250 REM * RETURN S0$ = TOKEN, A$ = STRING, N3 = NUMERIC
1251 REM *********
1260 IF X$<>" "THEN 1280
1270 GOSUB 1030\GOTO1260
1280 IF X$ < "A" THEN 1460
1282 IF X$ <="Z" THEN 1300
1284 IF X$ < "a" THEN 1460
1286 IF X$ > "z" THEN 1460
1300 K=0\A$="           "
1310 IF K>=N2 THEN 1330
1320 K=K+1\A$(K,K)=X$
1330 GOSUB 1030
1340 T=ASC(X$)
1350 IF T>47 AND T<58 OR T>64 AND T<91 THEN 1310
1355 IF T >96 AND T<123 THEN 1310
1360 REM BIN. SEARCH RES WORDS
1370 I=1\J=N0*5-4
1380 B$=A$
1390 K=INT((I+J)/10)*5+1
1400 Z$=W0$(K,K+4)
1410 IF B$<=Z$THEN J=K-5
1420 IF B$>=Z$THEN I=K+5
1430 IF I<=J THEN 1390
1440 IF I-5>J THEN S0$=B$ ELSE S0$="IDENT"
1450 RETURN
1460 Z$=""
1470 IF X$<"0"THEN 1580
1480 IF X$>"9"THEN 1580
1490 S0$="NUM"
1500 Z$=Z$+X$
1510 GOSUB 1030
1520 IF ASC(X$)>=48 AND ASC(X$)<=57 THEN 1500
1530 N3=VAL(Z$)
1540 IF N3<=N1 THEN RETURN
1550 E9=30\GOSUB 550
1560 N3=N1\RETURN
1570 REM CHECK FOR SPECIAL SYMBOL
1580 IF X$<>":"THEN 1640
1590 GOSUB 1030
1600 IF X$="=" THEN 1620
1610 S0$=":"\RETURN
1620 S0$=":="
1630 GOSUB 1030\RETURN
1640 IF X$<>"<"THEN 1710
1650 GOSUB 1030
1660 IF X$=">"THEN1690
1670 IF X$="=" THEN1700
1680 S0$="<"\RETURN
1690 S0$="<>"\GOSUB 1030\RETURN
1700 S0$="<="\GOSUB 1030\RETURN
1710 IF X$<>">"THEN 1750
1720 GOSUB 1030\S0$=">"
1730 IF X$<>"="THEN RETURN
1740 S0$=">="\GOSUB 1030\RETURN
1750 IF X$<>"'"THEN 1790
1760 S0$="STR"\C$=""
1770 GOSUB 1030\IF X$="'"THEN 1030
1780 C$=C$+X$\GOTO 1770
1790 IF X$<>"{"THEN 1820
1800 GOSUB 1030\IF X$<>"}"THEN 1800
1810 GOSUB 1030\GOTO 1240
1820 IF X$<>"%"THEN 1930
1830 GOSUB 1030\S0$="NUM"\N3=0
1840 FOR I=1 TO 4
1850 T=ASC(X$)
1860 IF T>=48 AND T<=57 THEN 1880
1870 IF T>=65 AND T<=70 THEN T=T-7 ELSE 1910
1880 T=T-48
1890 N3=N3*16+T\GOSUB1030\NEXT
1900 RETURN
1910 IF I>1 THEN Z=FNE(27)
1920 S0$="%"\RETURN
1930 S0$=X$\GOTO 1030
1940 REM *****
1950 REM ENTER SYMB INTO TABLE
1951 REM *****
1960 T1=T1+1
1970 T$((T1-1)*N2+1,T1*N2)=A$
1980 T0$(T1,T1)=K$\REM STORE TYPE
1990 IF K$<>"C"THEN 2010
2000 T2(T1)=N3\RETURN\REM STORE VALUE
2010 T1(T1)=L1\REM STORE LEVEL OF IDENT
2020 IF K$<>"V"THEN RETURN
2030 IF NOT F9 THEN RETURN
2040 T2(T1)=D0\D0=D0+1\RETURN\REM STORE OFFSET
2050 REM
2060 REM FIND IDENT
2070 REM
2080 J=(T1-1)*N2+1
2090 FOR I=T1TO1 STEP -1
2100 IF A$=T$(J,J+N2-1)THEN EXIT 2130
2110 J=J-N2\NEXT
2120 I=0
2130 RETURN
2140 REM *************
2150 REM PARSER AND CODER
2160 REM ************
2170 REM CONST DECLARTN
2180 Z=FNE1("IDENT",4)
2190 Z=FNE2("=",3)
2200 GOSUB 1240\GOSUB2240
2210 K$="C"\GOSUB 1950
2220 GOTO 1240
2230 REM***
2240 REM CONSTANT
2250 IF S0$="NUM"THEN RETURN
2260 IF S0$="IDENT"THEN2290\ REM CONST?
2270 Z=FNE1("STR",2)
2280 N3=ASC(C$)\RETURN
2290 GOSUB 2060 \IF I=0 THEN FNE(2)
2300 IF T0$(I,I)<>"C"THEN FNE(2)
2310 N3=T2(I)\ RETURN
2320 GOTO 1240
2330 REM***
2340 REM VARIABLE DECLARATION
2341 REM***
2350 Z=FNE1("IDENT",4)
2360 K$="V"\ GOSUB 1950\ GOTO 1240
2370 REM***
2380 REM SIMPLE EXPRESSION
2390 IF S0$="+" THEN 2420
2400 IF S0$<>"-" THEN 2590
2410 Y$=S0$\ GOSUB 6180
2420 GOSUB 1240
2430 GOSUB 2610
2440 GOSUB 6240
2450 IF Y$="-"THEN Z=FNG(1,0,1)
2460 IF S0$="+"THEN 2500
2470 IF S0$="-"THEN 2500
2480 IF S0$="OR   "THEN 2500
2490 RETURN
2500 Y$=S0$\ GOSUB 6180
2510 GOSUB 1240
2520 GOSUB 2610
2530 GOSUB 6240
2540 IF Y$="-"THEN 2570
2550 IF Y$="+" THEN 2580
2560 Z=FNG(1,0,14)\ GOTO 2460
2570 Z=FNG(1,0,3)\ GOTO 2460
2580 Z=FNG(1,0,2)\ GOTO 2460
2590 GOSUB 2610\ GOTO 2460
2600 REM ****
2610 REM TERM
2611 REM ****
2620 GOSUB 2850
2630 IF S0$="*" THEN 2700
2640 IF S0$="DIV  "THEN 2700
2650 IF S0$="AND  "THEN 2700
2660 IF S0$="MOD  "THEN 2700
2670 IF S0$="SHL  "THEN 2700
2680 IF S0$="SHR  "THEN 2700
2690 RETURN
2700 Y$=S0$\ GOSUB 6180\ REM PUSH
2710 GOSUB 1240\ GOSUB 2850
2720 GOSUB 6240
2730 IF Y$="DIV  "THEN 2790
2740 IF Y$="MOD  "THEN 2800
2750 IF Y$="*"THEN 2810
2760 IF Y$="SHL  "THEN 2820
2770 IF Y$="SHR  " THEN 2830
2780Z=FNG(1,0,15)\ GOTO 2630
2790 Z=FNG(1,0,5)\ GOTO 2630
2800 Z=FNG(1,0,7)\ GOTO 2630
2810 Z=FNG(1,0,4)\GOTO2630
2820 Z=FNG(1,0,17)\GOTO 2630
2830 Z=FNG(1,0,18)\GOTO 2630
2840 REM ***
2850 REM FACTOR
2860 IF S0$="IDENT"THEN 2940
2870 IF S0$="NUM" THEN 3060
2880 IF S0$="STR" THEN 3080
2890 IF S0$ ="(" THEN 3100
2900 IF S0$="MEM  " THEN 3140
2910 IF S0$="NOT  " THEN 3260
2920 Z=FNE(23)
2930 REM***
2940 GOSUB 2060
2950 IF I=0 THEN Z=FNE(11)
2960 IF T0$(I,I)="P" THEN Z=FNE(21)
2970 IF T0$(I,I)<>"Y"THEN 3000
2980 Z=FNG(5,0,1)
2990 I=I-1\ GOTO 4290
3000 IF T0$(I,I)="A" THEN 3190
3010 IF T0$(I,I)<>"C" THEN 3030
3020 Z=FNG(0,0,T2(I))\ GOTO 1240
3030 Z=FNG(2,L1-T1(I),T2(I))
3040 GOTO 1240
3050 REM*** NUM CONST
3060 Z=FNG(0,0,N3)\ GOTO 1240
3070 REM*** STRING CONST
3080 Z=FNG(0,0,ASC(C$))\ GOTO 1240
3090 REM*** PAREN EXPR
3100 GOSUB 1240\ GOSUB 3290
3110 IF S0$=")" THEN 1240
3120 Z=FNE(22)\ RETURN
3130 REM
3140 Z=FNE2("[",33)
3150 GOSUB 1240\ GOSUB 3290
3160 Z=FNE1("]",34)
3170 GOSUB 1240
3180 Z=FNG(2,255,0)\ RETURN
3190 X=I\ GOSUB 6120
3200 Z=FNE2("[",33)
3210 GOSUB 1240\ GOSUB 3290
3220 Z=FNE1("]",34)
3230 GOSUB 6150\ Z=FNG(18,L1-T1(X),T2(X))
3240 GOTO 1240
3250 REM***NEGATE
3260 GOSUB 1240\ GOSUB 2850
3270 Z=FNG(1,0,16)\RETURN
3280 REM***
3290 REM EXPRESSION
3300 GOSUB 2390\ REM SIMPLE EXP.
3310 IF S0$="=" THEN 3380
3320 IF S0$="<>"THEN 3380
3330 IF S0$="<" THEN 3380
3340 IF S0$="<="THEN 3380
3350 IF S0$=">" THEN 3380
3360 IF S0$=">="THEN 3380
3370 RETURN
3380 Y$=S0$\ GOSUB 6180
3390 GOSUB 1240\ GOSUB 2390
3400 GOSUB 6240
3410 IF Y$="=" THEN Z=FNG(1,0,8)
3420 IF Y$="<>"THEN Z=FNG(1,0,9)
3430 IF Y$="<" THEN Z=FNG(1,0,10)
3440 IF Y$=">="THEN Z=FNG(1,0,11)
3450 IF Y$=">" THEN Z=FNG(1,0,12)
3460 IF Y$="<="THEN Z=FNG(1,0,13)
3470 RETURN
3480 REM****
3490 REM STATEMENT
3500 IF S0$="IDENT" THEN 3630
3510 IF S0$="IF   " THEN 4440
3520 IF S0$="FOR  " THEN 5170
3530 IF S0$="WHILE" THEN 4800
3540 IF S0$="CASE " THEN 4890
3550 IF S0$="REPEA" THEN 4730
3560 IF S0$="BEGIN" THEN 4590
3570 IF S0$="READ " THEN 4040
3580 IF S0$="WRITE" THEN 3870
3590 IF S0$="MEM  " THEN 4650
3600 IF S0$="CALL " THEN 4240
3610 RETURN
3620 REM***ASSIGNMENT
3630 GOSUB 2060
3640 IF I=0 THEN Z=FNE(11)
3650 IF T0$(I,I)="A" THEN 3700
3660 IF T0$(I,I)="V" THEN 3760
3670 IF T0$(I,I)="Y" THEN 3760
3680 IF T0$(I,I)="P" THEN 4290
3690 Z=FNE(12)
3700 X=I \ GOSUB 6120
3710 X=16\ GOSUB 6120
3720 Z=FNE2("[",33)
3730 GOSUB 1240\ GOSUB 3290
3740 Z=FNE1("]",34)
3750 GOTO 3780
3760 X=I\ GOSUB 6120
3770 X=0\ GOSUB 6120
3780 GOSUB 1240
3790 IF S0$=":="THEN 3810
3800 Z=FNE(13)\ GOTO 3820
3810 GOSUB 1240
3820 GOSUB 3290\ GOSUB 6150
3830 K=X\ GOSUB 6150
3840 Z=FNG(3+K,L1-T1(X),T2(X))
3850 RETURN
3860 REM**WRITE
3870 Z=FNE2("(",31)
3880 GOSUB 1240\ IF S0$<>"STR" THEN 3950
3890 L=LEN(C$)\ IF L>1 THEN 3910
3900 Z=FNG(0,0,ASC(C$))\Z=FNG(8,0,1)\GOTO 3940
3910 FOR I=1 TO L
3920 Z=FNG(0,0,ASC(C$(I,I)))\ NEXT
3930 Z=FNG(0,0,L)\ Z=FNG(8,0,8)
3940 GOSUB 1240\ GOTO 4000
3950 GOSUB 3290\ K=1
3960 IF S0$="#" THEN K=3
3970 IF S0$="%"THEN K=5
3980 IF K>1 THEN GOSUB 1240
3990 Z=FNG(8,0,K)
4000 IF S0$="," THEN 3880
4010 Z=FNE1(")",22)
4020 GOTO 1240
4030 REM***READ
4040 Z=FNE2("(",31)
4050 Z=FNE2("IDENT",4)
4060 GOSUB 2060\ IF I=0 THEN Z=FNE(11)
4070 X=I\ GOSUB 6120
4080 IF T0$(I,I)="A" THEN 4190
4090 IF T0$(I,I)="V" THEN L=0 ELSE Z=FNE(4)
4100 GOSUB 1240\ K=0
4110 IF S0$="#"THEN K=2
4120 IF S0$="%"THEN K=4
4130 Z=FNG(8,0,K)
4140 IF K>0 THEN GOSUB 1240
4150 GOSUB 6150\ Z=FNG(L+3,L1-T1(X),T2(X))
4160 IF S0$="," THEN 4050
4170 Z=FNE1(")",31)
4180 GOTO 1240
4190 Z=FNE2("[",33)
4200 GOSUB 1240\ GOSUB 3290
4210 Z=FNE1("]",34)
4220 L=16\ GOTO 4100
4230 REM***ABS MEM CALL
4240 Z=FNE2("(",31)
4250 GOSUB 1240\ GOSUB 3290
4260 Z=FNE1(")",22)
4270 Z=FNG(4,255,0)\ GOTO 1240
4280 REM PROC OR FUNC CALL
4290 K2=0\ K3=I
4300 IF T3(I)=0 THEN 4400
4310 Z=FNE2("(",31)
4320 X=K2\ GOSUB 6120
4330 X=K3\ GOSUB 6120
4340 GOSUB 1240\ GOSUB 3290
4350 GOSUB 6150\ K3=X
4360 GOSUB 6150\ K2=X\K2=K2+1
4370 IF S0$="," THEN 4320
4380 IF K2<>T3(K3) THEN Z=FNE(35)
4390 Z=FNE1(")",22)
4400 Z=FNG(4,L1-T1(K3),T2(K3))
4410 IF K2<>0 THEN Z=FNG(5,0,-K2)
4420 GOTO 1240
4430 REM***IF
4440 GOSUB 1240
4450 GOSUB 3290
4460 Z=FNE1("THEN ",16)
4470 GOSUB 1240
4480 X=C1\ GOSUB 6120
4490 Z=FNG(7,0,0)
4500 GOSUB 3490
4510 IF S0$<>"ELSE "THEN 6520
4520 GOSUB 6150\ K=X
4530 X=C1\ GOSUB 6120
4540 Z=FNG(6,0,0)
4550 X=K\ GOSUB 6540
4560 GOSUB 1240\ GOSUB 3490
4570 GOTO 6520
4580 REM** CPD STATMNT
4590 GOSUB 1240
4600 GOSUB 3490
4610 IF S0$=";" THEN 4590
4620 IF S0$="END  "THEN 1240
4630 Z=FNE(17)\ RETURN
4640 REM WRITE MEM
4650 Z=FNE2("[",33)
4660 GOSUB 1240\ GOSUB 3290
4670 IF S0$<>"]"THEN Z=FNE(34)
4680 Z=FNE2(":=",13)
4690 GOSUB 1240\ GOSUB 3290
4700 Z=FNG(3,255,0)
4710 RETURN
4720REM***REP...UNTIL
4730 X=C1\ GOSUB 6120
4740 GOSUB 1240\ GOSUB 3490
4750 IF S0$=";" THEN 4740
4760 Z=FNE1("UNTIL",10)
4770 GOSUB 1240\ GOSUB 3290
4780 GOSUB 6150\ Z=FNG(7,0,X)\ RETURN
4790 REM***WHILE
4800 GOSUB 1240\ X=C1\ GOSUB 6120
4810 GOSUB 3290\ X=C1\ GOSUB 6120
4820 Z=FNG(7,0,0)
4830 Z=FNE1("DO   ",18)
4840 GOSUB 1240\ GOSUB 3490
4850 GOSUB 6150\ K=X\ GOSUB 6150
4860 Z=FNG(6,0,X)
4870 X=K\ GOTO 6540
4880 REM** CASE...OF
4890 GOSUB 1240\ GOSUB 3290
4900 Z=FNE1("OF   ",25)
4910 I2=1
4920 I1=0
4930 GOSUB 1240\ GOSUB 2240
4940 Z=FNG(1,0,21)\ Z=FNG(0,0,N3)\ Z=FNG(1,0,8)
4950 GOSUB 1240\ IF S0$=":"THEN4990
4960 Z=FNE1(",",5)
4970 X=C1\ GOSUB 6120\ Z=FNG(7,1,0)
4980 I1=I1+1\ GOTO 4930
4990 K=C1\ Z=FNG(7,0,0)
5000 FOR I=1 TO I1\ GOSUB 6520\ NEXT
5010 X=K\ GOSUB 6120
5020 GOSUB 1240\ X=I2\ GOSUB 6120
5030 GOSUB 3490\ GOSUB 6150\ I2=X
5040 IF S0$="ELSE " THEN 5090
5050 IF S0$<>";"THEN 5130
5060 K=C1\ Z=FNG(6,0,0)
5070 GOSUB 6520
5080 X=K\ GOSUB 6120\ I2=I2+1\ GOTO 4920
5090 K=C1\ Z=FNG(6,0,0)\ GOSUB 6520
5100 X=K\ GOSUB 6120
5110 GOSUB 1240\ X=I2\ GOSUB 6120
5120 GOSUB 3490\ GOSUB 6150\ I2=X
5130 Z=FNE1("END  ",17)
5140 FOR I=1 TO I2\ GOSUB 6520\ NEXT
5150 Z=FNG(5,0,-1)\ GOTO 1240
5160 REM**FOR
5170 Z=FNE2("IDENT",4)
5180 GOSUB 3630\ GOSUB 6120
5190 F9=1\ IF S0$="TO   "THEN 5210
5200 Z=FNE1("DOWNT",28)\F9=0
5210 GOSUB 1240\ GOSUB 3290
5220 GOSUB 6150\ K=X\ X=C1\ GOSUB 6120
5230 Z=FNG(1,0,21)\ Z=FNG(2,L1-T1(K),T2(K))
5240 Z=FNG(1,0,13-F9-F9)\X=C1\ GOSUB 6120\Z=FNG(7,0,0)
5250 X=F9\ GOSUB 6120\ X=K\ GOSUB 6120
5260 Z=FNE1("DO   ",18)\ GOSUB 1240
5270 GOSUB 3490\ GOSUB 6150\ Z=FNG(2,L1-T1(X),T2(X))
5280 K=X\ GOSUB 6150\ Z=FNG(1,0,20-X)
5290 Z=FNG(3,L1-T1(K),T2(K))
5300 GOSUB 6150\ K=X\ GOSUB 6150\ Z=FNG(6,0,X)
5310 X=K\ GOSUB 6540
5320 Z=FNG(5,0,-1)\ RETURN
5330 REM ****
5340 REM BLOCK
5341 REM ****
5350 D0=3
5360 T2(T1-K1)=C1
5370 Z=FNG(6,0,0)
5380 X=T1-K1\ GOSUB 6120
5390 IF S0$="CONST" THEN 5460
5400 IF S0$="VAR  " THEN 5550
5410 IF S0$="PROC " THEN 5730
5420 IF S0$="FUNC " THEN 5770
5430 IF S0$="BEGIN" THEN 5980
5440 Z=FNE(25)
5450 REM***CONST DCL
5460 GOSUB 1240
5470 GOSUB 2170
5480 Z=FNE1(";",5)\GOSUB 1240
5490 IF S0$="VAR  " THEN 5550
5500 IF S0$="PROC " THEN 5730
5510 IF S0$="FUNC " THEN 5770
5520 IF S0$="BEGIN" THEN 5980
5530 GOTO 5470
5540 REM***VAR. DCL
5550 L=0\ F9=1
5560 GOSUB 1240\ GOSUB 2340
5570 L=L+1\ IF S0$=","THEN 5560\REM+++++";"?????
5580 Z=FNE1(":",5)
5590 GOSUB 1240\ IF S0$="ARRAY"THEN 5610
5600 Z=FNE1("INTEG",36)\ GOTO 5670
5610 Z=FNE2("[",33)\ GOSUB 1240\ GOSUB 2240
5620 Z=FNE2("]",34)\ Z=FNE2("OF   ",26)\ Z=FNE2("INTEG",36)
5630 D0=D0-L
5640 FOR I=T1-L+1 TO T1
5650 T0$(I,I)="A"\ T3(I)=N3+1
5660 T2(I)=D0\ D0=D0+N3+1\ NEXT
5670 Z=FNE2(";",5)
5680 GOSUB 1240\ IF S0$="PROC "THEN 5730
5690 IF S0$="FUNC " THEN 5770
5700 IF S0$="BEGIN"THEN5980
5710 L=0\ F9=1\ GOSUB 2340\ GOTO 5570
5720 REM**
5730 Z=FNE2("IDENT",4)
5740 K1=0\ K$="P"\ GOSUB 1950
5750 L1=L1+1\ GOTO 5810
5760 REM**
5770 Z=FNE2("IDENT",4)
5780 K$="F"\ GOSUB 1950
5790L1=L1+1\ K1=1
5800 K$="Y"\ GOSUB 1950
5810 K2=K1\ GOSUB 1240
5820 X=T1\ GOSUB 6120
5830 X=D0\ GOSUB 6120
5840 IF S0$<>"("THEN 5890
5850 GOSUB 1240\ F9=0\ GOSUB 2340\ K1=K1+1
5860 IF S0$="," THEN 5850
5870 Z=FNE1(")",22)
5880 GOSUB 1240\ T3(T1-K1)=K1-K2
5890 Z=FNE1(";",5)
5900 FOR I=1TO K1
5910 T2(T1-I+1)=-I\ NEXT
5920 GOSUB 1240\ GOSUB 5340\ L1=L1-1
5930 GOSUB 6150\ D0=X
5940 GOSUB 6150\ T1=X
5950 Z=FNE1(";",5)
5960 GOSUB 1240\ GOTO 5410
5970 REM**
5980 GOSUB 1240\ GOSUB 6150\ K=X
5990 X=T2(K)\ GOSUB 6540
6000 T2(K)=C1
6010 Z=FNG(5,0,D0)
6020 GOSUB 3490
6030 IF S0$<>";"THEN 6050
6040 GOSUB 1240\ GOTO 6020
6050 IF S0$<>"END  "THEN Z=FNE(17)
6060 GOSUB 1240
6070 Z=FNG(1,0,0)
6080 RETURN
6090 REM***
6100 REM END PARSER
6110 REM***
6120 REM
6130 S(S9)=X\ S9=S9+1\ RETURN
6140 REM***
6150 REM POP X
6160 S9=S9-1\ X=S(S9)\ RETURN
6170 REM***
6180 REM PUSH Y$
6190 L=LEN(Y$)
6200 S$(P8,P8+L-1)=Y$
6210 X=P8\ GOSUB 6120
6220 X=P8+L-1\ GOSUB 6120
6230 P8=P8+L\ RETURN
6240 REM POP Y$
6250 GOSUB 6150
6260 L=X\ GOSUB 6150
6270 Y$=S$(X,L)
6280 P8=P8-L+X-1
6290 RETURN
6300 REM***
6310 REM GEN CODES
6320 DEF FNG(X1,X2,X3)
6330 B$="   "
6340 FILL P9,X1\ FILL P9+1,X2
6350 FILL P9+2,FNA(X3)\ FILL P9+3,FNB(X3)
6360 IF Y9 THEN 6400
6370 IF X1<16 THEN 6390
6380 B$(1,1)="X"\X1=X1-16
6390 !%4I,C1,"  ",M$(X1*3+1,X1*3+3),B$,%3I,X2,%6I,X3
6400 C1=C1+1\ P9=P9+4
6410 IF P9>=Q9 THEN Z=FNE(1)
6420 RETURN 0
6430 FNEND
6440 REM**
6450 DEF FNB(Z)
6460 N=INT(Z/256)
6470 IF N<0 THEN N=256+N
6480 RETURN N
6490 FNEND
6500 DEF FNA(Z)=Z-INT(Z/256)*256
6510 REM***
6520 REM FIXUP
6530 GOSUB 6150
6540 N=P7+X*4
6550 FILL N+2,FNA(C1)\ FILL N+3,FNB(C1)
6560 IF Y9 THEN RETURN
6570!" ADD AT",X," CHANGED TO",C1
6580 RETURN
